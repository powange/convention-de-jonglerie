// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id             Int      @id @default(autoincrement())
  email          String   @unique
  pseudo         String   @unique
  nom            String
  prenom         String
  password       String
  profilePicture String?  // URL vers la photo de profil
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Editions created by this user
  createdEditions Edition[] @relation("CreatedEditions")

  // Editions favorited by this user
  favoriteEditions Edition[] @relation("FavoriteEditions")

  // Conventions where this user is a collaborator
  collaborations ConventionCollaborator[]
  
  // Collaborations added by this user
  addedCollaborators ConventionCollaborator[] @relation("AddedCollaborators")
  
  // Carpools offered by this user
  carpoolOffers CarpoolOffer[]
  
  // Carpool requests created by this user
  carpoolRequests CarpoolRequest[]
  
  // Comments on carpools
  carpoolComments CarpoolComment[]
  
  // Comments on carpool requests
  carpoolRequestComments CarpoolRequestComment[]
}

model Edition {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  imageUrl    String?
  startDate   DateTime
  endDate     DateTime
  addressLine1 String
  addressLine2 String?
  postalCode   String
  city         String
  region       String?
  country      String
  ticketingUrl String?
  facebookUrl  String?
  instagramUrl String?
  hasFoodTrucks     Boolean @default(false)
  hasKidsZone       Boolean @default(false)
  acceptsPets       Boolean @default(false)
  hasTentCamping    Boolean @default(false)
  hasTruckCamping   Boolean @default(false)
  hasGym            Boolean @default(false)
  hasFamilyCamping  Boolean @default(false)
  hasFireSpace      Boolean @default(false)
  hasGala           Boolean @default(false)
  hasOpenStage      Boolean @default(false)
  hasConcert        Boolean @default(false)
  hasCantine        Boolean @default(false)
  hasAerialSpace    Boolean @default(false)
  hasSlacklineSpace Boolean @default(false)
  hasToilets        Boolean @default(false)
  hasShowers        Boolean @default(false)
  hasAccessibility  Boolean @default(false)
  hasWorkshops      Boolean @default(false)
  hasCreditCardPayment Boolean @default(false)
  hasAfjTokenPayment   Boolean @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relation to the user who created this edition
  creatorId Int
  creator   User @relation("CreatedEditions", fields: [creatorId], references: [id])

  // Users who favorited this edition
  favoritedBy User[] @relation("FavoriteEditions")

  // Collaborators with edit permissions
  collaborators ConventionCollaborator[]
  
  // Carpools for this edition
  carpoolOffers CarpoolOffer[]
  
  // Carpool requests for this edition
  carpoolRequests CarpoolRequest[]
}

model ConventionCollaborator {
  id           Int      @id @default(autoincrement())
  conventionId Int
  userId       Int
  canEdit      Boolean  @default(true)
  addedAt      DateTime @default(now())
  addedById    Int

  // Relations
  convention Edition    @relation(fields: [conventionId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  addedBy    User       @relation("AddedCollaborators", fields: [addedById], references: [id])

  // Ensure a user can only be added once per convention
  @@unique([conventionId, userId])
}

// Carpool offers for editions
model CarpoolOffer {
  id               Int      @id @default(autoincrement())
  editionId        Int
  userId           Int
  departureDate    DateTime
  departureCity    String
  departureAddress String
  availableSeats   Int
  description      String?  @db.Text
  phoneNumber      String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  edition    Edition          @relation(fields: [editionId], references: [id], onDelete: Cascade)
  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments   CarpoolComment[]
}

// Carpool requests for editions
model CarpoolRequest {
  id               Int      @id @default(autoincrement())
  editionId        Int
  userId           Int
  departureDate    DateTime
  departureCity    String
  seatsNeeded      Int      @default(1)
  description      String?  @db.Text
  phoneNumber      String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  edition    Edition              @relation(fields: [editionId], references: [id], onDelete: Cascade)
  user       User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments   CarpoolRequestComment[]
}

// Comments on carpool offers
model CarpoolComment {
  id             Int      @id @default(autoincrement())
  carpoolOfferId Int
  userId         Int
  content        String   @db.Text
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  carpoolOffer CarpoolOffer @relation(fields: [carpoolOfferId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Comments on carpool requests
model CarpoolRequestComment {
  id               Int      @id @default(autoincrement())
  carpoolRequestId Int
  userId           Int
  content          String   @db.Text
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  carpoolRequest CarpoolRequest @relation(fields: [carpoolRequestId], references: [id], onDelete: Cascade)
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
}


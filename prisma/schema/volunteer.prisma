// =============================================================================
// Bénévoles — Candidatures, équipes, planning, notifications, commentaires
// =============================================================================

enum VolunteerMode {
  INTERNAL
  EXTERNAL
}

enum DietaryPreference {
  NONE
  VEGETARIAN
  VEGAN
}

enum AllergySeverity {
  LIGHT
  MODERATE
  SEVERE
  CRITICAL
}

enum VolunteerStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum VolunteerApplicationSource {
  APPLICATION // Candidature spontanée via formulaire
  MANUAL // Ajout manuel par un organisateur
}

model EditionVolunteerApplication {
  id                    Int                         @id @default(autoincrement())
  editionId             Int
  userId                Int
  status                VolunteerStatus             @default(PENDING)
  motivation            String?                     @db.Text
  allergies             String?                     @db.Text
  allergySeverity       AllergySeverity?
  createdAt             DateTime                    @default(now())
  updatedAt             DateTime                    @updatedAt
  decidedAt             DateTime?
  userSnapshotPhone     String?
  dietaryPreference     DietaryPreference           @default(NONE)
  timePreferences       Json?
  teamPreferences       Json?
  acceptanceNote        String?                     @db.Text
  hasPets               Boolean?
  petsDetails           String?                     @db.Text
  hasMinors             Boolean?
  minorsDetails         String?                     @db.Text
  hasVehicle            Boolean?
  vehicleDetails        String?                     @db.Text
  companionName         String?                     @db.Text
  avoidList             String?                     @db.Text
  skills                String?                     @db.Text
  hasExperience         Boolean?
  experienceDetails     String?                     @db.Text
  setupAvailability     Boolean?
  teardownAvailability  Boolean?
  eventAvailability     Boolean?
  arrivalDateTime       String?
  departureDateTime     String?
  emergencyContactName  String?
  emergencyContactPhone String?
  qrCodeToken           String?                     @unique
  entryValidated        Boolean                     @default(false)
  entryValidatedAt      DateTime?
  entryValidatedBy      Int?
  source                VolunteerApplicationSource  @default(APPLICATION)
  addedById             Int?
  addedAt               DateTime?
  edition               Edition                     @relation(fields: [editionId], references: [id], onDelete: Cascade)
  user                  User                        @relation(fields: [userId], references: [id], onDelete: Cascade)
  addedBy               User?                       @relation("ManuallyAddedVolunteers", fields: [addedById], references: [id], onDelete: SetNull)
  teamAssignments       ApplicationTeamAssignment[]
  mealSelections        VolunteerMealSelection[]

  @@unique([editionId, userId])
  @@index([editionId])
  @@index([status])
  @@index([userId], map: "EditionVolunteerApplication_userId_fkey")
  @@index([entryValidated])
  @@index([source])
  @@index([addedById])
  @@index([qrCodeToken])
}

// ========== NOTIFICATIONS BÉNÉVOLES ==========

model VolunteerNotificationGroup {
  id             String   @id @default(cuid())
  editionId      Int
  senderId       Int
  title          String
  message        String   @db.Text
  targetType     String // 'all' ou 'teams'
  selectedTeams  Json? // Array des équipes sélectionnées si targetType = 'teams'
  recipientCount Int
  sentAt         DateTime @default(now())

  edition       Edition                             @relation(fields: [editionId], references: [id], onDelete: Cascade)
  sender        User                                @relation(fields: [senderId], references: [id])
  confirmations VolunteerNotificationConfirmation[]

  @@index([editionId])
  @@index([senderId])
}

model VolunteerNotificationConfirmation {
  id                           String    @id @default(cuid())
  volunteerNotificationGroupId String
  userId                       Int
  confirmedAt                  DateTime?

  notificationGroup VolunteerNotificationGroup @relation(fields: [volunteerNotificationGroupId], references: [id], onDelete: Cascade)
  user              User                       @relation(fields: [userId], references: [id])

  @@unique([volunteerNotificationGroupId, userId])
  @@index([userId])
}

// ========== PLANNING BÉNÉVOLES ==========

model VolunteerTeam {
  id                    String   @id @default(cuid())
  editionId             Int
  name                  String
  description           String?  @db.Text
  color                 String   @default("#6b7280") @db.VarChar(7)
  maxVolunteers         Int?
  isRequired            Boolean  @default(false)
  isAccessControlTeam   Boolean  @default(false)
  isMealValidationTeam  Boolean  @default(false)
  isVisibleToVolunteers Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  edition              Edition                          @relation(fields: [editionId], references: [id], onDelete: Cascade)
  timeSlots            VolunteerTimeSlot[]
  assignedApplications ApplicationTeamAssignment[]
  returnableItems      EditionVolunteerReturnableItem[]
  conversations        Conversation[]

  @@index([editionId])
}

model VolunteerTimeSlot {
  id                 String   @id @default(cuid())
  editionId          Int
  teamId             String?
  title              String?
  description        String?  @db.Text
  startDateTime      DateTime
  endDateTime        DateTime
  maxVolunteers      Int      @default(1)
  assignedVolunteers Int      @default(0)
  delayMinutes       Int?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  edition     Edition               @relation(fields: [editionId], references: [id], onDelete: Cascade)
  team        VolunteerTeam?        @relation(fields: [teamId], references: [id], onDelete: SetNull)
  assignments VolunteerAssignment[]

  @@index([editionId])
  @@index([teamId])
}

model VolunteerAssignment {
  id           String   @id @default(cuid())
  timeSlotId   String
  userId       Int
  assignedAt   DateTime @default(now())
  assignedById Int

  timeSlot   VolunteerTimeSlot @relation(fields: [timeSlotId], references: [id], onDelete: Cascade)
  user       User              @relation("VolunteerAssignment_user", fields: [userId], references: [id], onDelete: Cascade)
  assignedBy User              @relation("VolunteerAssignment_assignedBy", fields: [assignedById], references: [id], onDelete: Cascade)

  @@unique([timeSlotId, userId])
  @@index([timeSlotId])
  @@index([userId])
  @@index([assignedById])
}

// ========== ASSIGNATION ÉQUIPES BÉNÉVOLES ==========

model ApplicationTeamAssignment {
  applicationId Int
  teamId        String
  isLeader      Boolean  @default(false)
  assignedAt    DateTime @default(now())

  application EditionVolunteerApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  team        VolunteerTeam               @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@id([applicationId, teamId])
  @@index([teamId])
  @@index([isLeader])
}

model VolunteerComment {
  id        Int      @id @default(autoincrement())
  userId    Int
  editionId Int
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  edition Edition @relation(fields: [editionId], references: [id], onDelete: Cascade)

  @@unique([userId, editionId])
  @@index([userId])
  @@index([editionId])
}

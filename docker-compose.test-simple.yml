services:
  # Container pour les tests unitaires uniquement (sans DB)
  test-unit:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: convention-test-unit
    environment:
      NODE_ENV: 'test'
      CI: 'true'
    volumes:
      - ./app:/app/app:cached
      - ./server:/app/server:cached
      - ./tests:/app/tests:cached
      - ./scripts:/app/scripts:cached
      - ./prisma:/app/prisma:cached
      - ./public:/app/public:cached
      - ./nuxt.config.ts:/app/nuxt.config.ts:cached
      - ./vitest.config.unit.ts:/app/vitest.config.unit.ts:cached
      - node_modules:/app/node_modules
    command:
      - sh
      - -c
      - |
        # Si le volume node_modules est vide (cache frais), installer les deps
        if [ ! -x node_modules/.bin/vitest ]; then
          echo "node_modules absent: installation des d√©pendances..."
          npm ci
        fi
        npx vitest run --config vitest.config.unit.ts --silent

volumes:
  node_modules:
    driver: local
